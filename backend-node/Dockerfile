# Dockerfile pour krown-api (Backend Node.js)
FROM node:20-alpine

# Installer les d√©pendances syst√®me si n√©cessaire
# (pour communiquer avec le socket Unix de l'agent et g√©n√©rer les certificats)
RUN apk add --no-cache \
    bash \
    openssl

# Cr√©er le r√©pertoire de travail
WORKDIR /app

# Mettre √† jour npm pour avoir une version r√©cente (sans vuln√©rabilit√©s)
RUN npm install -g npm@latest

# Copier les fichiers de d√©pendances
COPY package.json ./

# Installer les d√©pendances (production + dev pour le d√©veloppement)
# Corriger automatiquement les vuln√©rabilit√©s si possible
RUN npm install && \
    npm audit fix || true

# Copier le code source
COPY server.js ./
COPY agent-client.js ./
COPY https-server.js ./

# Cr√©er le r√©pertoire pour les certificats SSL
RUN mkdir -p /app/certs

# Cr√©er un utilisateur non-root (sans sp√©cifier de GID/UID pour √©viter les conflits)
RUN addgroup -S nodeuser && \
    adduser -S -G nodeuser nodeuser && \
    chown -R nodeuser:nodeuser /app

USER nodeuser

# Exposer les ports
EXPOSE 8080 8443

# Script d'entr√©e pour g√©n√©rer les certificats si n√©cessaire
RUN echo '#!/bin/sh' > /docker-entrypoint.sh && \
    echo '# G√©n√©rer les certificats SSL si absents et HTTPS activ√©' >> /docker-entrypoint.sh && \
    echo 'if [ "$USE_HTTPS" != "false" ] && [ "$USE_HTTPS" != "0" ]; then' >> /docker-entrypoint.sh && \
    echo '  if [ ! -f /app/certs/cert.pem ] || [ ! -f /app/certs/key.pem ]; then' >> /docker-entrypoint.sh && \
    echo '    echo "üîê G√©n√©ration automatique des certificats SSL auto-sign√©s..."' >> /docker-entrypoint.sh && \
    echo '    openssl req -x509 -newkey rsa:4096 \' >> /docker-entrypoint.sh && \
    echo '      -nodes \' >> /docker-entrypoint.sh && \
    echo '      -keyout /app/certs/key.pem \' >> /docker-entrypoint.sh && \
    echo '      -out /app/certs/cert.pem \' >> /docker-entrypoint.sh && \
    echo '      -days 365 \' >> /docker-entrypoint.sh && \
    echo '      -subj "/C=FR/ST=State/L=City/O=Krown/CN=localhost" \' >> /docker-entrypoint.sh && \
    echo '      -addext "subjectAltName=DNS:localhost,DNS:*.localhost,IP:127.0.0.1" 2>/dev/null' >> /docker-entrypoint.sh && \
    echo '    if [ $? -eq 0 ]; then' >> /docker-entrypoint.sh && \
    echo '      chmod 600 /app/certs/key.pem' >> /docker-entrypoint.sh && \
    echo '      chmod 644 /app/certs/cert.pem' >> /docker-entrypoint.sh && \
    echo '      echo "‚úì Certificats SSL g√©n√©r√©s automatiquement dans /app/certs/"' >> /docker-entrypoint.sh && \
    echo '    else' >> /docker-entrypoint.sh && \
    echo '      echo "‚ö†Ô∏è  Erreur lors de la g√©n√©ration des certificats"' >> /docker-entrypoint.sh && \
    echo '    fi' >> /docker-entrypoint.sh && \
    echo '  else' >> /docker-entrypoint.sh && \
    echo '    echo "‚úì Certificats SSL trouv√©s dans /app/certs/"' >> /docker-entrypoint.sh && \
    echo '  fi' >> /docker-entrypoint.sh && \
    echo 'fi' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo 'exec node server.js' >> /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh

# Point d'entr√©e
CMD ["/docker-entrypoint.sh"]

